name: Build

on:
  pull_request:
    branches:
      - "*"
  workflow_dispatch:

jobs:
  build-v2:
    runs-on: ubuntu-22.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl unzip xz-utils zip \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libglu1-mesa \
            libusbmuxd-tools usbmuxd \
            libgl1-mesa-dev

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set variables
        run: |
          HASH=$(cat SNAPSHOT_HASH)
          echo "SNAPSHOT_HASH=$HASH" >> $GITHUB_ENV

      - name: Install Python tools
        run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip install .

      - name: Clone depot_tools and engine
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          git clone https://github.com/flutter/engine.git

      - name: gclient sync
        run: |
          ROOT_DIR=$(pwd)
          export PATH=$PATH:$ROOT_DIR/depot_tools

          cd engine
          git config --global user.email "reflutter@example.com"
          git config --global user.name "reflutter"

          git fetch origin $(reflutter -b ${{env.SNAPSHOT_HASH}})
          git reset --hard FETCH_HEAD

          reflutter -b ${{env.SNAPSHOT_HASH}}
          echo 'reflutter' > REFLUTTER
          git add . && git commit -am "reflutter"

          cd $ROOT_DIR
          mkdir customEngine
          cd customEngine

          echo 'solutions = [{"managed": False,"name": "src/flutter","url": "'$ROOT_DIR/engine'","custom_deps": {},"deps_file": "DEPS","safesync_url": "",},]' > .gclient

          gclient sync
          reflutter -b ${{env.SNAPSHOT_HASH}}

      - name: Build libflutter_x64 (Android)
        run: |
          export PATH=$PATH:$(pwd)/depot_tools
          customEngine/src/flutter/tools/gn --no-goma --android --android-cpu=x64 --runtime-mode=release
          ninja -C customEngine/src/out/android_release_x64

      - name: Move to release
        run: |
          cp customEngine/src/out/android_release_x64/lib.stripped/libflutter.so libflutter_x86_64.so 2>/dev/null || :

      - name: Android-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v2-${{env.SNAPSHOT_HASH}}
          files: |
            ./*.so
